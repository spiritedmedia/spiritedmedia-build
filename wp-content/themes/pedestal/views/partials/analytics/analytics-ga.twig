{% if site.analytics.ga_id and not site.analytics.hide_ga %}

    {% if site.analytics.ga_optimize_id %}
        <style>.async-hide { opacity: 0 !important} </style>
        <script>(function(a,s,y,n,c,h,i,d,e){s.className+=' '+y;h.start=1*new Date;
        h.end=i=function(){s.className=s.className.replace(RegExp(' ?'+y),'')};
        (a[n]=a[n]||[]).hide=h;setTimeout(function(){i();h.end=null},c);h.timeout=c;
        })(window,document.documentElement,'async-hide','dataLayer',4000,
        {'{{ site.analytics.ga_optimize_id }}':true});</script>
    {% endif %}

    <script>
        if(document.cookie.indexOf('is_staff=') >= 0) {
          window['ga-disable-{{ site.analytics.ga_id }}'] = true;
        }
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', '{{ site.analytics.ga_id }}', 'auto', {'allowLinker': true});
        ga('require', 'displayfeatures');

        {% if site.analytics.ga_optimize_id %}
            ga('require', '{{ site.analytics.ga_optimize_id }}');
        {% endif %}

        ga('require', 'linker');
        ga('linker:autoLink', ['checkout.fundjournalism.org']);

        ga(function(tracker) {
            {# If no cookie is set #}
            var contactEmailDimension = 'Unknown';
            var memberLevelDimension = 'Unknown';

            var contactData = localStorageCookie('contactData');
            if (contactData && 'data' in contactData) {
                var data = contactData.data;

                {# Contact Email Dimension #}
                if ( data.subscribed_to_list ) {
                    contactEmailDimension = 'Other';
                }

                if ( data.newsletter_subscriber ) {
                    contactEmailDimension = 'Daily Newsletter';
                }

                {# Contact Member Level Dimension #}
                if ( !data.current_member && !data.donate_365 ) {
                    memberLevelDimension = 'None';
                }

                if ( !data.current_member && data.donate_365 ) {
                    memberLevelDimension = 'Donor';
                }

                {#
                    In theory this conditional should never be triggered
                    but if something goes wrong with data.member_level
                    this will have us convered
                #}
                if ( data.current_member ) {
                    memberLevelDimension = 'Error';
                }

                if ( data.current_member && data.member_level > 0 ) {
                    memberLevelDimension = 'Member ' + data.member_level;
                }
            }
            tracker.set('dimension1', contactEmailDimension);
            tracker.set('dimension2', memberLevelDimension);

            {#
                Setup a global variable to store the cross-domain linker paramter for use in our own scripts
                See https://developers.google.com/analytics/devguides/collection/analyticsjs/linker#linkerparam
            #}
            window.gaLinkTrackerParam = tracker.get('linkerParam');
        });

        ga('send', 'pageview');
    </script>
{% endif %}
<script> if( typeof ga !== 'function' ) { ga = false; } </script>
