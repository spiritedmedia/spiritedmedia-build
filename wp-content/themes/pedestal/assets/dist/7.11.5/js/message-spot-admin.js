!function(){"use strict";function t(o,r,s){var a;return function(){var t=this,e=arguments,n=function(){return o.apply(t,e)},i=s&&!a;clearTimeout(a),a=setTimeout(n,r),i&&n()}}function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function e(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&n(t,e)}function r(t){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function n(t,e){return(n=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function a(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}var l=function(){function r(t,e,n){if(s(this,r),this.$el=t,this.$modelStorage=this.$el.find(".fm-preview_model .fm-element"),this.modelDefaults=n,0<this.$modelStorage.length){var i=decodeURIComponent(this.$modelStorage.val());i&&(this.modelDefaults=JSON.parse(i))}var o=Backbone.Model.extend({defaults:this.modelDefaults,$storage:this.$modelStorage,sync:function(){var t=encodeURIComponent(JSON.stringify(this));this.$storage.val(t)}});this.Model=new o,this.View=new e({el:this.$el,model:this.Model})}return e(r,[{key:"destroy",value:function(){this.View.destroy()}}]),r}(),u=function(){function i(t,e,n){s(this,i),this.$el=t,this.previewView=e,this.defaults=n,this.createPreview()}return e(i,[{key:"createPreview",value:function(){this.Preview=new l(this.$el,this.previewView,this.defaults)}},{key:"destroyPreview",value:function(){"destroy"in this.Preview&&this.Preview.destroy(),this.Preview=null}},{key:"setPreviewAttribute",value:function(t,e){this.Preview.View.model.save(t,e)}},{key:"getPreviewFrame",value:function(){return this.Preview.View.$output}}]),i}(),c=PedestalIcons;var d=window.Twig;d.extendFunction("ped_icon",function(t,e){if(t=t.trim(),!c.hasOwnProperty(t))throw'[getIconSVG] The icon "'.concat(t,"\" doesn't seem to exist!");var n=$(c[t].svg);return n.addClass(e),n[0].outerHTML}),d.extendFilter("esc_attr",function(t){return e=e?"&#13;":"\n",(""+t).replace(/&/g,"&amp;").replace(/'/g,"&apos;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r\n/g,e).replace(/[\r\n]/g,e);var e}),d.extendFilter("esc_url",function(t){return escape(t)});var f=d.twig,h=function(t){var e=this;this.editor=null,this.editorID=!1,this.$el=$(t.el),this.model=t.model,this.setupFrame(),this.$output.on("load",function(){var t=e.$el.find(".fm-body .fm-element");t.hasClass("fm-richtext")&&(e.editorID=t.attr("id"),e.listenToBodyEditor()),e.render()}),this.listenTo(this.model,"change",this.render),Backbone.View.apply(this,arguments)};h.extend=Backbone.View.extend,Object.assign(h.prototype,Backbone.View.prototype,{listeningToEditor:!1,widthButtonLabels:{toDesktop:"Switch to desktop preview",toMobile:"Switch to mobile preview"},setupFrame:function(){var t=this.$el.find(".fm-id .fm-element").val();this.$outputContainer=this.$el.find(".js-message-preview-container"),this.$outputContainer.html('\n      <iframe src="'.concat(pedestalPreviewURL).concat(t,'/"\n        class="message-preview js-message-preview js-responsive-iframe"\n        data-true-width="645"\n        data-true-height="260"\n      ></iframe>\n    ')),this.$output=this.$outputContainer.find(".js-message-preview")},setupFrameWidthToggle:function(){this.$toggleWidthButton=$('\n      <button\n        title="Change preview width"\n        class="js-message-preview-toggle-width button-secondary"\n      >'.concat(this.widthButtonLabels.toDesktop,"</button>\n    ")),this.$toggleWidthButton.insertAfter(this.$outputContainer)},onToggleWidthClick:function(t){var e=$(t.target),n="message-preview-container--large";e.text()===this.widthButtonLabels.toDesktop?(e.text(this.widthButtonLabels.toMobile),this.$outputContainer.addClass(n)):(e.text(this.widthButtonLabels.toDesktop),this.$outputContainer.removeClass(n)),t.preventDefault()},listenToBodyEditor:function(){var n=this;if("undefined"!=typeof tinyMCE&&this.editorID){var i=function(){n.editor.on("keyup",t(function(){n.model.save("body",n.editor.getContent())},300)),n.listeningToEditor=!0};tinyMCE.hasOwnProperty("editors")&&$.each(tinyMCE.editors,function(t,e){!n.listeningToEditor&&e.hasOwnProperty("id")&&e.id.trim()===n.editorID&&(n.editor=e,i())}),tinyMCE.on("AddEditor",function(t){n.listeningToEditor||t.editor.id!==n.editorID||(n.editor=t.editor,i())})}},listenToIconButton:t(function(t){var e=$(t.currentTarget).data("message-icon-value");this.model.save("icon_name",e)},300),destroy:function(){this.undelegateEvents(),this.editor&&"off"in this.editor&&this.editor.off(),this.$el.removeData().unbind(),this.$output.remove(),this.$toggleWidthButton&&this.$toggleWidthButton.remove()}});var m=h.extend({initialize:function(){var t=this;this.$templateProto=this.$el.find(".js-message-template-proto"),this.template=f({data:this.$templateProto.html()}),this.setupFrameWidthToggle(),this.$output.contents().on("focus",".js-message-spot",function(){t.$output.focus()})},render:function(){var t=this.model.toJSON();switch(t.additional_classes=this.getVariantClass(),t.type){case"standard":t.title=!1,t.button_label=!1;break;case"with_title":case"override":t.button_label=!1;break;case"with_button":t.icon=!1,t.title=!1}t.body||(t.body=this.model.get("postTitle")||this.model.defaults.body);var e=this.template.render(t);return this.$output.contents().find("body").html(e),this},events:{"change .fm-type .fm-element":function(t){this.model.save("type",t.target.value)},"keyup .fm-body .fm-element":function(t){this.model.save("body",t.target.value)},"input .fm-url .fm-element":function(t){this.model.save("url",t.target.value)},"input .fm-title .fm-element":function(t){this.model.save("title",t.target.value)},"input .fm-button_label .fm-element":function(t){this.model.save("button_label",t.target.value)},"click .js-ped-icon-button":function(t){this.model.save("icon",$(t.currentTarget).data("message-icon-value"))},"click .js-message-preview-toggle-width":"onToggleWidthClick"},getVariantClass:function(){var t=this.model.get("type");if("standard"===t)return"";var e="message-spot--".concat(t.replace("_","-"));return"override"===t&&(e+=" message-spot--with-title"),e}}),p=PedestalIcons,v=function(){function n(t){var e=this;s(this,n),this.$el=$(t),this.$iconOptions=this.$el.find(".fm-option .fm-element"),this.createButtons(),this.$buttons=this.$el.find(".js-ped-icon-button"),this.$buttons.on("click",function(t){return e.onClick(t)}),this.$buttons.on("keydown",function(t){return e.onKeydown(t)})}return e(n,[{key:"createButtons",value:function(){this.$iconOptions.each(function(t,e){var n=$('label[for="'.concat(e.id,'"]')),i=$.trim(n.text()),o=e.value,r=e.checked?" is-checked":"",s=p[o].svg,a='\n        <a href="#"\n          title="'.concat(i,'"\n          class="js-ped-icon-button ped-icon-button button-secondary ').concat(r,'"\n          data-message-icon-value="').concat(o,'"\n        >\n          ').concat(s,"\n        </a>\n      ");e.style.display="none",n.hide(),$(a).insertAfter(e)})}},{key:"onClick",value:function(t){var e=$(t.currentTarget);this.$buttons.removeClass("is-checked"),this.$buttons.find(".fm-element:radio").attr("checked",!1),e.addClass("is-checked"),e.prev(".fm-element:radio").attr("checked",!0),t.preventDefault()}},{key:"onKeydown",value:function(t){32==t.which&&$(t.currentTarget).trigger("click")}}]),n}(),g=function(t){function n(t){var e;return s(this,n),(e=a(this,r(n).call(this,t,m,messagePreviewDefaults.standard))).iconButtons=new v(t.find(".fm-icon")),e}return o(n,u),n}(),w=function(t){function n(){var e;return s(this,n),(e=a(this,r(n).call(this,$(".fm-override"),m,messagePreviewDefaults.override))).post=null,e.$el.on("change",".fm-autocomplete-hidden",function(t){return e.onPostSelection(t)}),e}return o(n,u),e(n,[{key:"onPostSelection",value:function(t){var n=this,e=$(t.target),i=parseInt(e.val()),o=e.closest(".fm-group-inner"),r=o.find(".fm-body .fm-element"),s=o.find(".fm-url .fm-element");if(!i)return r.val(""),void s.val("");var a={post_id:i,action:"pedestal-message-spot-override"};$.post(ajaxurl,a,function(t){if(t.data){n.post=t.data,r.val(n.post.title),n.setPreviewAttribute("body",n.post.title),o.find(".fm-post_title .fm-element").val(n.post.title),n.setPreviewAttribute("postTitle",n.post.title);var e=encodeURI(n.post.url);s.val(e),n.setPreviewAttribute("url",e)}})}}]),n}();jQuery(document).ready(function(i){i(".fm-message:not(.fmjs-proto)").each(function(){new g(i(this))}),i(document).on("fm_added_element",function(t){var e=i(t.target),n=function(){for(var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:8,e="",n="23456789abdegjkmnpqrvwxyz",i=0;i<t;i++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}();e.find(".fm-id .fm-element").val(n),new g(e)});var e=function(t){var e=i(t),n=e.closest(".fm-group-inner").find(".fm-wrapper:not(.fm-enabled-wrapper)");"true"===e.val()?(window.MessageSpotOverride=new w,n.show()):(n.hide(),window.MessageSpotOverride instanceof w&&window.MessageSpotOverride.destroyPreview(),window.MessageSpotOverride=null)};e(".fm-enabled .fm-element:checked"),i(document).on("change",".fm-enabled .fm-element",function(t){return e(t.target)})})}();