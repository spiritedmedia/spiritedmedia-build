"use strict";var _createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}String.prototype.toCamelCase=function(){return this.replace(/\s(.)/g,function(e){return e.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(e){return e.toLowerCase()})},String.prototype.capFirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.escAttr=function(e){return e=e?"&#13;":"\n",this.replace(/&/g,"&amp;").replace(/'/g,"&apos;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r\n/g,e).replace(/[\r\n]/g,e)},Object.defineProperty(Object.prototype,"toAttsString",{value:function(){var e="";for(var t in this)if(this.hasOwnProperty(t)){var n=this[t];Array.isArray(n)&&(n=n.join(" ")),("string"==typeof n||n instanceof String)&&(e+=t+'="'+n.escAttr()+'" ')}return e},enumerable:!1});var PedUtils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"debounce",value:function(o,i,s){var a;return function(){var e=this,t=arguments,n=s&&!a;clearTimeout(a),a=setTimeout(function(){a=null,s||o.apply(e,t)},i||200),n&&o.apply(e,t)}}},{key:"throttle",value:function(e,t){var n=!1;return function(){n||(e.call(),n=!0,setTimeout(function(){n=!1},t))}}},{key:"removeHash",value:function(){history.pushState("",document.title,window.location.pathname+window.location.search)}},{key:"focusAtEnd",value:function(e){if(0<e.length){var t=e[0],n=t.value.length;(t.selectionStart||"0"==t.selectionStart)&&(t.selectionStart=n,t.selectionEnd=n,t.focus())}}},{key:"genStr",value:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:8,t="",n="23456789abdegjkmnpqrvwxyz",o=0;o<e;o++)t+=n.charAt(Math.floor(Math.random()*n.length));return t}}]),e}(),Message={Preview:{},loadPreview:function(e){var t=e.find(".fm-preview_model .fm-element"),n={};0<t.length&&(n=(n=t.val())?JSON.parse(n):{});var o=new Message.Preview.Model(n);o.$storage=t;var i=new Message.Preview.View({el:e,model:o}),s=e.parent();s.one("sortstart",function(){return i.destroy()}),s.one("sortstop",function(){return Message.loadPreview(e)})},createIconButton:function(e){var t=$('label[for="'+e.id+'"]'),n=$.trim(t.text()),o=e.value,i='\n      <a href="#"\n        title="'+n+'"\n        class="js-message-icon-button message-icon-button button-secondary '+(e.checked?" is-checked":"")+'"\n        data-message-icon-value="'+o+'"\n      >\n        '+PedestalIcons[o].svg+"\n      </a>\n    ";t.hide(),$(i).insertAfter(e)}};Message.Preview.Model=Backbone.Model.extend({defaults:messagePreviewModelDefaults,sync:function(){this.$storage.val(JSON.stringify(this.toJSON()))}}),Message.Preview.View=Backbone.View.extend({model:Message.Preview.Model,listeningToEditor:!1,widthButtonLabels:{toDesktop:"Switch to desktop preview",toMobile:"Switch to mobile preview"},initialize:function(){var e=this;this.$templateProto=this.$el.find(".js-message-spot-template-proto"),this.template=Twig.twig({id:this.id,data:this.$templateProto.html()}),this.setupFrame(),this.$output.on("load",function(){e.editorID=e.$el.find(".fm-body .fm-element").attr("id"),e.listenToBodyEditor(),e.render()}),this.listenTo(this.model,"change",this.render),this.$output.contents().on("focus",".js-message-spot",function(){e.$output.focus()})},render:function(){var e=this.model.toJSON();switch(e.additional_classes=this.getVariantClass(),e.type){case"standard":e.title=!1,e.button_label=!1;break;case"with_title":e.button_label=!1;break;case"with_button":e.icon=!1,e.title=!1}e.body||(e.body=this.model.defaults.body);var t=this.template.render(e);return this.$output.contents().find("body").html(t),this},events:{"change .fm-type .fm-element":function(e){this.model.save("type",e.target.value)},"keyup .fm-body .fm-tinymce":function(e){this.model.save("body",e.target.value)},"input .fm-url .fm-element":function(e){this.model.save("url",e.target.value)},"input .fm-title .fm-element":function(e){this.model.save("title",e.target.value)},"input .fm-button_label .fm-element":function(e){this.model.save("button_label",e.target.value)},"click .js-message-icon-button":"onIconButtonClick","keydown .js-message-icon-button":"onIconButtonKeydown","click .js-message-spot-preview-toggle-width":"onToggleWidthClick"},setupFrame:function(){var e=this.$el.find(".fm-id .fm-element").val();this.$outputContainer=this.$el.find(".js-message-spot-preview-container"),this.$outputContainer.html('\n      <iframe src="'+pedestalPreviewURL+e+'"\n        class="message-spot-preview js-message-spot-preview"\n        width="100%"></iframe>\n    '),this.$output=this.$outputContainer.find(".js-message-spot-preview"),$('\n      <button\n        title="Change preview width"\n        class="js-message-spot-preview-toggle-width button-secondary"\n      >'+this.widthButtonLabels.toDesktop+"</button>\n    ").insertAfter(this.$outputContainer)},onIconButtonClick:function(e){var t=$(e.currentTarget),n=this.$el.find(".js-message-icon-button");n.removeClass("is-checked"),n.find(".fm-element:radio").attr("checked",!1),t.addClass("is-checked"),t.prev(".fm-element:radio").attr("checked",!0),e.preventDefault(),this.model.save("icon",t.data("message-icon-value"))},onIconButtonKeydown:function(e){32==e.which&&$(e.currentTarget).trigger("click")},onToggleWidthClick:function(e){var t=$(e.target),n="message-spot-preview-container--large";t.text()===this.widthButtonLabels.toDesktop?(t.text(this.widthButtonLabels.toMobile),this.$outputContainer.addClass(n)):(t.text(this.widthButtonLabels.toDesktop),this.$outputContainer.removeClass(n)),e.preventDefault()},listenToBodyEditor:function(){var n=this;if("undefined"!=typeof tinyMCE){var o=function(){n.editor.on("keyup",function(){n.model.save("body",n.editor.getContent())}),n.listeningToEditor=!0};tinyMCE.hasOwnProperty("editors")&&$.each(tinyMCE.editors,function(e,t){!n.listeningToEditor&&t.hasOwnProperty("id")&&t.id.trim()===n.editorID&&(n.editor=t,o())}),tinyMCE.on("AddEditor",function(e){n.listeningToEditor||e.editor.id!==n.editorID||(n.editor=e.editor,o())})}},getVariantClass:function(){var e=this.model.get("type");return"standard"===e?"":"message-spot--"+e.replace("_","-")},destroy:function(){this.undelegateEvents(),this.editor.off(),this.$el.removeData().unbind(),this.$output.remove()}}),jQuery(document).ready(function(o){Twig.extendFunction("ped_icon",function(e,t){if(e=e.trim(),!PedestalIcons.hasOwnProperty(e))throw'[Message Spot] The icon "'+e+"\" doesn't seem to exist!";var n=o(PedestalIcons[e].svg);return n.addClass(t),n[0].outerHTML}),o(".fm-icon .fm-option .fm-element").each(function(e,t){t.style.display="none",Message.createIconButton(t)}),o(".fm-message:not(.fmjs-proto) .fm-group-label-wrapper").each(function(e){0===e&&o(".js-message-spot-prompt").addClass("has-messages"),Message.loadPreview(o(this).parent())}),o(document).on("fm_added_element",function(e){var t=o(e.target),n=PedUtils.genStr();t.find(".fm-id .fm-element").val(n),o(".js-message-spot-prompt").addClass("has-messages"),Message.loadPreview(t)})});